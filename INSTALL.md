# Установка и настройка погодной станции

## Требования

- Плата ESP32
- Датчик DHT22 (температура и влажность)
- Датчик BMP280 (атмосферное давление)
- Платформа разработки PlatformIO

## Подключение датчиков

### DHT22
- VCC → 3.3V
- GND → GND
- DATA → GPIO4

### BMP280
- VCC → 3.3V
- GND → GND
- SDA → GPIO21
- SCL → GPIO22

## Установка PlatformIO

### Вариант 1: VS Code
1. Установите [Visual Studio Code](https://code.visualstudio.com/)
2. Установите расширение [PlatformIO IDE](https://platformio.org/install/ide?install=vscode)
3. Откройте папку проекта в VS Code

### Вариант 2: Командная строка
```bash
pip install -U platformio
```

## Настройка проекта

### 1. Клонирование репозитория
```bash
git clone <URL_репозитория>
cd weather-station
```

### 2. Установка библиотек
При использовании PlatformIO IDE библиотеки будут установлены автоматически на основе файла `platformio.ini`.

Для ручной установки:
```bash
pio lib install
```

## Загрузка прошивки

### Вариант 1: PlatformIO IDE
1. Подключите ESP32 к компьютеру через USB
2. Выберите правильный порт в настройках PlatformIO
3. Нажмите кнопку "Upload" или выполните команду:

```bash
pio run --target upload
```

### Вариант 2: Командная строка
```bash
# Сборка проекта
pio run

# Загрузка на устройство
pio run --target upload --upload-port /dev/ttyUSB0
```

## Конфигурация

Основные параметры проекта можно изменить в файле `weather_station.ino` в namespace `WeatherStationConfig`:

```cpp
namespace WeatherStationConfig {
    const char* WIFI_SSID = "WEATHER_STATION_AP";
    const char* WIFI_PASSWORD = "weather123";
    const int DHT_PIN = 4;
    const int DHT_TYPE = DHT22;
    const unsigned long MEASUREMENT_INTERVAL = 60000; // Интервал измерений в мс
    const unsigned long ARCHIVE_INTERVAL = 604800000; // Интервал архивации в мс (7 дней)
    const size_t MAX_DATA_POINTS = 1008; // Максимальное количество точек данных
}
```

## Отладка

### Мониторинг Serial
Для отслеживания работы устройства используйте Serial Monitor:

```bash
pio device monitor
```

Или через VS Code: PlatformIO IDE → Serial Monitor

### Уровень отладки
Уровень отладки можно изменить в файле `platformio.ini`:

```ini
build_flags = 
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_INFO
```

Доступные уровни:
- `ARDUHAL_LOG_LEVEL_NONE` - нет отладки
- `ARDUHAL_LOG_LEVEL_ERROR` - только ошибки
- `ARDUHAL_LOG_LEVEL_WARN` - предупреждения и ошибки
- `ARDUHAL_LOG_LEVEL_INFO` - информационные сообщения
- `ARDUHAL_LOG_LEVEL_DEBUG` - подробная отладка
- `ARDUHAL_LOG_LEVEL_VERBOSE` - максимально подробная отладка

## Использование

### Подключение к точке доступа
После загрузки прошивки устройство создаст точку доступа Wi-Fi:

- SSID: `WEATHER_STATION_AP`
- Пароль: `weather123`

Подключитесь к этой сети с любого устройства (телефон, планшет, компьютер).

### Доступ к веб-интерфейсу
Откройте браузер и перейдите по адресу: `http://192.168.4.1`

Доступные страницы:
- `/` - главная страница с текущими данными
- `/data` - JSON с текущими погодными данными
- `/predict` - JSON с прогнозом погоды

### API примеры
Получение текущих данных:
```bash
curl http://192.168.4.1/data
```

Получение прогноза:
```bash
curl http://192.168.4.1/predict
```

## Тестирование датчиков

Для проверки работы датчиков можно использовать пример из папки `examples/sensor_test.ino`:

```cpp
/*
 * Пример скетча для тестирования датчиков погодной станции
 * 
 * Этот скетч позволяет протестировать работу датчиков по отдельности
 * перед запуском основной программы погодной станции.
 */
```

Загрузите этот скетч для проверки подключения датчиков.

## Устранение неполадок

### Устройство не подключается к Wi-Fi
- Проверьте питание ESP32
- Убедитесь, что антенна подключена правильно

### Данные датчиков не читаются
- Проверьте правильность подключения датчиков
- Убедитесь в правильной настройке пинов в коде
- Проверьте питание датчиков (должно быть 3.3V)

### Ошибка при загрузке
- Проверьте выбранный порт
- Убедитесь, что драйвера USB-UART установлены
- Попробуйте перезагрузить ESP32 в режим прошивки (обычно кнопка BOOT/FLASH)

### Нет доступа к веб-интерфейсу
- Убедитесь, что подключены к правильной точке доступа
- Попробуйте обновить страницу
- Проверьте IP-адрес устройства (обычно 192.168.4.1)

## Обновление прошивки

Для обновления прошивки до новой версии:

1. Обновите код проекта:
```bash
git pull
```

2. Перезагрузите прошивку:
```bash
pio run --target upload
```

## Производительность

### Потребление энергии
- Режим работы: ~240mA
- Режим сна: ~10-20mA (требует дополнительной настройки)

### Память
- Flash: ~2MB
- RAM: ~320KB

### Интервалы
- Интервал измерений: 1 минута (по умолчанию)
- Интервал архивации: 7 дней
- Максимум точек в памяти: 1008 (неделя при 10-мин интервале)

## Безопасность

- Точка доступа защищена паролем
- Веб-интерфейс доступен только в локальной сети
- Нет внешнего доступа к устройству
- Рекомендуется изменить стандартный пароль в коде
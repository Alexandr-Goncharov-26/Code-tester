# Система хранения данных погодной станции

## Обзор

Система хранения данных в погодной станции реализована с использованием SPIFFS (SPI Flash File System) - файловой системы, оптимизированной для работы с флэш-памятью ESP32. Система обеспечивает хранение текущих и архивных данных с автоматическим архивированием недельных данных.

## Архитектура хранения

### 1. Класс DataStorage

Основной класс `DataStorage` реализует следующую функциональность:

- Хранение текущей истории данных в оперативной памяти
- Сохранение данных в SPIFFS при архивации
- Управление циклическим буфером данных
- Автоматическое архивирование по расписанию

### 2. Структура данных

Данные хранятся в структуре `WeatherData`:

```cpp
struct WeatherData {
    float temperature;      // Температура в градусах Цельсия
    float humidity;         // Влажность в процентах
    float pressure;         // Давление в Паскалях
    float predictedTemp;    // Предсказанная температура
    float predictedHumidity; // Предсказанная влажность
    unsigned long timestamp; // Временная метка
};
```

## Организация данных

### 1. Оперативное хранение

- Используется циклический буфер в оперативной памяти
- Максимальное количество точек: 1008 (неделя при интервале 10 минут)
- При переполнении буфера старые данные заменяются новыми

### 2. Архивное хранение

- Архивирование данных каждые 7 дней (604800000 миллисекунд)
- Формат хранения: JSON
- Именование файлов: `/archive_[timestamp].json`

### 3. Формат архива

Архивные файлы содержат массив JSON-объектов:

```json
[
    {
        "temp": 23.5,
        "humidity": 65.2,
        "pressure": 101325.0,
        "predicted_temp": 24.1,
        "predicted_humidity": 63.8,
        "timestamp": 1234567890
    },
    ...
]
```

## SPIFFS (SPI Flash File System)

### Преимущества

- Оптимизирован для флэш-памяти ESP32
- Поддержка стандартных файловых операций
- Защита от преждевременного износа флэш-памяти
- Интеграция с Arduino API

### Ограничения

- Ограниченный объем доступной памяти
- Ограниченное количество циклов записи
- Необходимость эффективного управления файлами

## Управление памятью

### 1. Циклический буфер

Для эффективного использования оперативной памяти реализован циклический буфер:

```cpp
WeatherData dataHistory[WeatherStationConfig::MAX_DATA_POINTS];
size_t dataCount = 0;
```

При достижении максимального размера буфера новые данные заменяют самые старые:

```cpp
if (dataCount >= WeatherStationConfig::MAX_DATA_POINTS) {
    // Сдвигаем элементы буфера
    for (size_t i = 0; i < WeatherStationConfig::MAX_DATA_POINTS - 1; i++) {
        dataHistory[i] = dataHistory[i + 1];
    }
    dataHistory[WeatherStationConfig::MAX_DATA_POINTS - 1] = data;
} else {
    dataHistory[dataCount] = data;
    dataCount++;
}
```

### 2. Оптимизация памяти

- Использование статических массивов вместо динамического выделения
- Минимизация дублирования данных
- Эффективное использование структур данных

## Архивирование данных

### 1. Алгоритм архивации

Процесс архивации включает следующие шаги:

1. Создание нового архивного файла с уникальным именем
2. Преобразование данных из буфера в JSON-формат
3. Запись данных в файл
4. Очистка буфера после успешной записи

### 2. Именование файлов

Архивные файлы именуются по шаблону: `/archive_[timestamp].json`

Где `timestamp` - текущее время в миллисекундах с момента запуска устройства.

### 3. Управление файлами

- Проверка успешности открытия файлов
- Обработка ошибок записи
- Оптимизация размера файлов

## Безопасность и надежность

### 1. Защита от потери данных

- Проверка результатов операций записи
- Обработка ошибок файловой системы
- Контроль целостности данных

### 2. Устойчивость к сбоям

- Проверка инициализации SPIFFS
- Обработка ситуаций с нехваткой памяти
- Восстановление после ошибок

## Производительность

### 1. Оптимизация операций ввода-вывода

- Минимизация количества операций записи
- Буферизация данных перед записью
- Эффективное использование JSON-библиотеки

### 2. Управление ресурсами

- Оптимальный размер буфера для баланса между памятью и частотой архивации
- Эффективное использование памяти при сериализации JSON

## Масштабируемость

### 1. Настройка параметров

Конфигурационные параметры позволяют настраивать систему:

```cpp
const unsigned long ARCHIVE_INTERVAL = 604800000; // 7 дней
const size_t MAX_DATA_POINTS = 1008; // Количество точек данных за неделю
```

### 2. Расширяемость

- Возможность изменения формата хранения
- Поддержка различных интервалов архивации
- Расширение структуры данных

## Мониторинг и диагностика

### 1. Получение статистики

Класс предоставляет методы для получения информации о состоянии хранилища:

- `getStoredDataCount()` - количество текущих данных в буфере
- Методы для получения истории данных

### 2. Логирование

- Вывод информации об архивации в Serial
- Отладочная информация о состоянии файловой системы

## Заключение

Система хранения данных погодной станции реализована с учетом ограничений встроенной системы и обеспечивает надежное хранение как текущих, так и архивных данных. Архитектура позволяет эффективно использовать доступные ресурсы ESP32 и обеспечивает автоматическое архивирование данных с заданным интервалом.